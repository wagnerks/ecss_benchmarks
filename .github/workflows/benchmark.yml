name: Benchmarks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  benchmark-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run benchmarks
        timeout-minutes: 10
        run: |
          mkdir -p benchmark-results
          ./build/ecss_benchmarks --benchmark_format=json --benchmark_out=benchmark-results/results-gcc.json --benchmark_min_time=0.1s

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-gcc
          path: benchmark-results/results-gcc.json

  benchmark-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Run benchmarks
        timeout-minutes: 30
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path benchmark-results
          .\build\Release\ecss_benchmarks.exe --benchmark_format=json --benchmark_out=benchmark-results\results-msvc.json --benchmark_min_time=0.1s

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-msvc
          path: benchmark-results/results-msvc.json

  publish:
    needs: [benchmark-linux, benchmark-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download GCC results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-gcc
          path: gh-pages

      - name: Download MSVC results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-msvc
          path: gh-pages

      - name: Keep legacy results.json (copy from gcc)
        run: cp gh-pages/results-gcc.json gh-pages/results.json

      - name: Minify JSON results
        run: |
          cd gh-pages
          node -e "
          const fs = require('fs');
          ['results-gcc.json', 'results-msvc.json'].forEach(file => {
            if (!fs.existsSync(file)) return;
            const data = JSON.parse(fs.readFileSync(file, 'utf8'));
            const min = {
              context: data.context,
              benchmarks: data.benchmarks.map(b => ({ name: b.name, cpu_time: b.cpu_time }))
            };
            const outFile = file.replace('.json', '.min.json');
            fs.writeFileSync(outFile, JSON.stringify(min));
            console.log(file + ' -> ' + outFile + ' (' + (fs.statSync(outFile).size/1024).toFixed(1) + ' KB)');
          });
          "

      - name: Upload to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
